#!/usr/bin/env python3

import nmap
import pandas as pd
import json
from network_device_scan import main as scan_network

def vulnerability_scan(device_ip):
    nm = nmap.PortScanner()
    nm.scan(hosts=device_ip, arguments='-sV --script vuln')
    vulnerabilities = nm[device_ip].get('hostscript', [])
    return vulnerabilities

def scan_vulnerabilities_for_devices(devices_df):
    vulnerability_scan_results = []

    for index, device in devices_df.iterrows():
        device_ip = device['IP Address']
        device_name = device['Device Name']
        host_name = device['Host Name']
        mac_address = device['MAC Address']

        vulnerabilities = vulnerability_scan(device_ip)
        vulnerability_scan_results.append({
            'Device Name': device_name,
            'Host Name': host_name,
            'IP Address': device_ip,
            'MAC Address': mac_address,
            'Vulnerabilities': vulnerabilities
        })

    return vulnerability_scan_results

def save_vulnerability_scan_results_to_file(results_df):
    results_df.to_json("vulnerability_scan_results.json", orient='records')

def main():
    devices_df = scan_network()
    vulnerability_scan_results = scan_vulnerabilities_for_devices(devices_df)

    results_df = pd.DataFrame(vulnerability_scan_results)
    results_df.to_excel("vulnerability_scan_results.xlsx", index=False)
    print("The vulnerability scan results have been saved to 'vulnerability_scan_results.xlsx'")

    save_vulnerability_scan_results_to_file(results_df)

if __name__ == "__main__":
    main()
